# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ travis-kind ]
  pull_request:
    branches: [ travis-kind ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        python-version: ['3.7.5']
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - uses: docker-practice/actions-setup-docker@master
      # Runs a set of commands using the runners shell
      - name: Update apt-get
        run: sudo apt-get update
      - name: Install packages
        run: sudo apt-get install -y build-essential clang-7 llvm-7 libelf-dev python3.7 python3-pip libcmocka-dev lcov python3.7-dev python3-apt pkg-config
      - name: Python3.6
        run: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 1
      - name: Python3.7
        run: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 2
      - name: Python3.7 default
        run: sudo update-alternatives --set python3 /usr/bin/python3.7
      - name: Python3.7 symlink fix
        run: sudo ln -s /usr/lib/python3/dist-packages/apt_pkg.cpython-36m-x86_64-linux-gnu.so /usr/lib/python3/dist-packages/apt_pkg.so
      - name: Update pip
        run: python3 -m pip install --upgrade pip
      - name: Install python packages
        run: sudo pip3 install setuptools netaddr docker grpcio grpcio-tools kubernetes
      - name: install kind
        run: |
          ver=$(curl -s https://api.github.com/repos/kubernetes-sigs/kind/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          curl -Lo kind "https://github.com/kubernetes-sigs/kind/releases/download/$ver/kind-$(uname)-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin
      - name: Install kubectl
        run: |
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          git submodule update --init --recursive
      - name: Compile mizar
        run: sudo make clean && make && sudo make unittest
      - name: Run cli unit tests
        run: ./build/tests/test_cli
      - name: Run daemon unit tests
        run: ./build/tests/test_dmn
      - name: Run kind e2efunctest
        run: make e2efunctest

