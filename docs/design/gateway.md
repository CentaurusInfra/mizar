##基于基础网关的表项按需下发技术

###需求
在云网络中，每当VPC上线时，都需要在计算节点上下发流表。当VPC规模很大时，虚机上线的速度就会很慢。为提高虚机上线的速度，计算节点表项按需下发需要满足：

1. 在虚拟机上线时只部署少量必要流表，其余表项在虚拟机上线后逐步按需下发；
2. 上线时下发的流表项大小与VPC规模解耦；
3. 部署在宿主机上的表项数量大大减少，从而降低高密度服务器的过载和故障风险；
4. 在虚拟机迁移时不需要同步全部计算节点。


###网关节点模型
为提高虚机上线的速度，我们设计了网关节点转发模型。一个网关节点存储了一个VPC或多个VPC的全局表项信息。在网关节点转发模型中，当一个虚机上线时，表项配置主要分为两个部分：

1. 下发虚机相关配置，使之接入网络，然后配置一条默认路由以将新上线的虚机的流量转发至网关节点，由网关节点查询全局路由信息，实现转发操作。此时虚机已经上线成功，并可以和其他虚机进行通信；
2. 为已经通信过的虚机对下发规则，然后可以不再经过网关节点实现通信，即direct-path。

![avatar](https://github.com/HuaqingTu/MarkdownImages/blob/master/gateway/gateway.PNG)


###网关节点集群
网关节点集群指的是使用多个网关节点来负责一个大规模的VPC或者若干个小的VPC。这是出于网络健壮性和性能的考虑。网关节点集群有以下特点：

1. 同一个网关节点集群内的网关节点完全identical；
2. 一个VPC的流量仅会被分配到一个网关节点集群；
3. 从健壮性角度考虑，每个网关节点集群内至少包含2个网关节点；
4. 存在一个空闲网关节点集群，其作用是当某一个网关节点集群出现过载的情况时，从空闲集群中拿一个分配个过载的集群。
 


###桶的框架设计
为了从源节点实现网关节点集群的负载均衡，在每个计算节点侧的OVS设计一个桶的结构。当一个Node上的一个数据包需要转发且在Node节点上的流表没有匹配的规则时，这个数据包需要被发给网关节点。通过VPC id计算a = hash（VPC id）％M，虚拟交换机将其哈希到计算节点的某个桶中，其中M为桶的数量，其大小是固定的。桶可以使用Round Robin算法把数据包发送给网关节点集群中的某一个网关节点。

桶到网关节点集群的映射确保以下原则：

1. 所属同一个VPC的流量尽可能集中到1个或者若干个网关节点（即大VPC流量集中到多个网关节点，构成一个网关节点集群，同一个网关），从而保证该租户流量发生异常时，对其他租户的影响尽量小。
2. 每个网关节点管理若干个小VPC，一个大VPC独占若干个网关节点，从而确保某个网关节点发生异常时，所受影响的VPC数量尽量少。此外可以确保每个网关节点上保存的表项信息尽量少（管理哪些VPC就保存哪些VPC的表项信息）；
3. 每个网关节点所转发的流量不能超过网关节点的能力限制。后续若由于某个VPC扩容或者流量增多，则需要进行桶与网关节点映射的更新，确保网关节点不过载。

桶与网关节点的映射更新主要由以下事件触发：

1. 某个网关节点过载，则需要将部分映射更新至其他网关节点，更新映射的原则如上3点；
2. 某个网关节点失效，则需要将与该网关节点有映射的桶全部更新到其他网关节点进行映射，更新映射的原则如上3点；
3. 某个网关节点新增，有两种处理方式：其一是先作为备份网关节点，等待其他网关节点失效或者过载，再将部分桶映射更新到该新增网关节点上；其二是查找负载较高的网关节点，将部分到该网关节点的映射更新到新增网关节点上，以达到网关节点间的负载均衡。在做映射更新时，需要同时更新网关节点上保存的表项信息，确保每个网关节点保存有其管理的VPC表项信息。



