import os
import sys
import psutil
from multiprocessing import Pool


def update_map(cmd):
    if os.system(cmd) != 0:
            print("update err")


if len(sys.argv) < 3:
    print("usage: python3 insert_map.py mode num")
    print("mode:")
    print("      1： update ep_kernel_map")
    print("      2： update ep_offload_map")
    print("      3： update both")
    print("num:")
    print("      int： number of element u wanna update")
    exit()
mode  = int(sys.argv[1])
num = int(sys.argv[2])
cmd = 'bpftool map'
count = 0
ep_map_id_kernel = 0
ep_map_id_offload = 0
for line in os.popen(cmd).readlines():
    if count > 1:
        break
    if 'endpoints_map' in line and count == 0:
        ep_map_id_kernel = int(line[:line.find(' ')-1])
        count += 1
        continue
    if 'endpoints_map' in line and count == 1:
        ep_map_id_offload = int(line[:line.find(' ')-1])
        count += 1
        continue
if ep_map_id_kernel == 0 or ep_map_id_offload == 0:
    print("not find map")
    exit()
print("ep_map_id_kernel", ep_map_id_kernel)
print("ep_map_id_offload", ep_map_id_offload)

value_kernel_5 = '0x02 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0xac 0x10 0x32 0x67 0x18 0x38 0x11 0x83 0x40 0x00 0x00 0x00 0x40 0x61 0x00 0x00 0x0d 0x06 0xb1 0x66 0xff 0xff 0xff 0xff 0xa5 0x5b 0x00 0x33 0x61 0x00 0x00 0x00'
value_kernel = '0x01 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0xac 0x10 0xa0 0x66 0xfc 0x7f 0x00 0x00 0x50 0x00 0x00 0x00 0x20 0x60 0x00 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0xfc 0x7f 0x00 0x00 0x14 0xdb 0xff 0xb4 0xfc 0x7f 0x00 0x00 0xa8 0xda 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x98 0xda 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x80 0xdb 0xff 0xb4 0x31 0x35 0x00 0x00 0x0a 0x00 0x00 0x00 0x15 0xf7 0xa3 0x2c 0x7c 0xdb 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x46 0x38 0xf1 0x2e 0x43 0x7f 0x00 0x00 0x0c 0x00 0x00 0x00 0x40 0x62 0x00 0x00 0x60 0x89 0x14 0x2f 0x43 0x7f 0x00 0x00 0xfb 0x1f 0x00 0x00 0x00 0x00 0x00 0x00 0x48 0x0e 0xe3 0x2e 0x43 0x7f 0x00 0x00 0xf8 0xda 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x00 0x2c 0x4f 0x37 0x00 0x00 0x00 0x00 0xb0 0xda 0xff 0xb4 0xfc 0x7f 0x00 0x00 0xf8 0xda 0xff 0xb4 0xfc 0x7f 0x00 0x00 0xe0 0xdb 0xff 0xb4 0x33 0x34 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0xdc 0xdb 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x46 0x38 0xf1 0x2e 0x43 0x7f 0x00 0x00 0x0c 0x00 0x00 0x00 0x40 0x62 0x00 0x00 0x60 0x89 0x14 0x2f 0x43 0x7f 0x00 0x00 0xfb 0x1f 0x00 0x00 0x00 0x00 0x00 0x00 0x0f 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0c 0x00 0x00 0x32 0x34 0x34 0x35 0x32 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x88 0x4e 0xe3 0x8e 0x02 0x56 0x00 0x00 0x15 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x44 0x2f 0xdc 0x2e 0x43 0x7f 0x00 0x00 0x18 0x00 0x00 0x00 0x30 0x00 0x00 0x00 0x20 0xdc 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x60 0xdb 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x84 0x5f 0x00 0x00 0x00 0x00 0x00 0x00 0x37 0x39 0xe4 0x2e 0x43 0x7f 0x00 0x00 0x80 0x07 0x00 0x00 0x00 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xd0 0xdb 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x40 0xdc 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0xe0 0x5e 0x14 0x2f 0x43 0x7f 0x00 0x00 0x03 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xa0 0xff 0xff 0x3a 0x0b 0xe8 0x2e 0x43 0x7f 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xa0 0x60 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xa0 0xff 0xff 0x59 0x5d 0xdb 0x8e 0x02 0x56 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x61 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xba 0x84 0xe7 0x2e 0x43 0x7f 0x00 0x00 0x80 0xdd 0xff 0xb4 0xfc 0x7f 0x00 0x00 0xea 0x59 0xd6 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xa0 0x60 0x00 0x00 0x9e 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x22 0x00 0x00 0x00 0x36 0x00 0x00 0x00 0x0a 0x00 0x00 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7a 0x00 0x00 0x00 0x04 0x00 0x00 0x00 0x05 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xfc 0x7f 0x00 0x00 0x80 0x70 0x00 0x00 0x00 0x00 0x00 0x00 0x50 0x00 0x00 0x00 0x20 0x60 0x00 0x00 0x30 0x00 0x00 0x00 0x30 0x00 0x00 0x00 0x00 0xde 0xff 0xb4 0xfc 0x7f 0x00 0x00 0xf0 0xdc 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x80 0x0a 0x00 0x00 0xc0 0x60 0x00 0x00 0x90 0x18 0x00 0x00 0x30 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xb7 0x40 0xe3 0x8e 0x02 0x56 0x00 0x00 0xcd 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x12 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xce 0x00 0x00 0x00 0x40 0x00 0x00 0x00 0x40 0x60 0x00 0x00 0x53 0xad 0xeb 0x2e 0x43 0x7f 0x00 0x00 0xf0 0xc3 0x14 0x2f 0x43 0x7f 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x08 0xde 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x01 0xac 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x08 0xde 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x21 0xa4 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0xc0 0x82 0x14 0x2f 0x43 0x7f 0x00 0x00 0x87 0xb0 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x14 0xde 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xdc 0x0b 0xe8 0x2e 0x43 0x7f 0x00 0x00 0xf0 0xdd 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x1c 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x20 0x61 0x00 0x00 0x00 0x00 0x00 0x00 0x40 0x61 0x00 0x00 0x1c 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x49 0x92 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xf0 0xdd 0xff 0xb4 0xfc 0x7f 0x00 0x00 0x82 0xbb 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x40 0x61 0x00 0x00 0x82 0xbb 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x14 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x40 0x61 0x00 0x00 0xf1 0xb1 0xeb 0x2e 0x43 0x7f 0x00 0x00 0x0a 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2c 0x4f 0x37 0x15 0xf7 0xa3 0x2c 0x40 0x00 0x00 0x00 0x40 0x61 0x00 0x00 0xff 0xff 0xff 0xff 0x7e 0xd6 0xfa 0x5c 0xc9 0x18 0x00 0x00'
value_offload = '0x01 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0xac 0x10 0xa0 0x67 0xfc 0x7f 0x00 0x00 0x50 0x00 0x00 0x00 0x20 0x60 0x00 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x06 0x00 0x00 0x00 0x42 0x39 0xb9 0xf4 0x8f 0xcb 0x00 0x00'

if mode == 1 or mode ==3:
    pool = Pool(psutil.cpu_count())
    for i in range(num):
        key = '0xff %s %s %s %s 0 0 0 %s %s %s %s' % (
        i % 255, (i >> 8) % 255, (i >> 16) % 255, (i >> 24) % 255, (i >> 24) % 255, (i >> 16) % 255, (i >> 8) % 255,
        i % 255)
        cmd = "bpftool map update id %s key %s value %s" % (ep_map_id_kernel, key, value_kernel_5)
        pool.apply_async(update_map, (cmd,))
    pool.close()
    pool.join()
    cmd = "bpftool map dump id %s" % ep_map_id_kernel
    print("ep_kernel_map update finished, now map has num:", os.popen(cmd).readlines()[-1])
if mode == 2 or mode ==3:
    pool = Pool(psutil.cpu_count())
    for i in range(num):
        key = '0xff %s %s %s %s 0 0 0 %s %s %s %s' % (
        i % 255, (i >> 8) % 255, (i >> 16) % 255, (i >> 24) % 255, (i >> 24) % 255, (i >> 16) % 255, (i >> 8) % 255,
        i % 255)
        cmd = "bpftool map update id %s key %s value %s" % (ep_map_id_offload, key, value_offload)
        pool.apply_async(update_map, (cmd,))
    pool.close()
    pool.join()
    cmd = "bpftool map dump id %s" % ep_map_id_offload
    print("ep_offload_map update finished, now map has num:", os.popen(cmd).readlines()[-1])
